<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Morpheme Matrix Playground (Grades 3‚Äì5)</title>
  <style>
    :root{
      --bg1:#7dd3ff; --bg2:#b8ffcf; --bg3:#ffe38d;
      --card:#ffffffee; --ink:#13233f; --muted:#3b5876;
      --a:#7a5cff; --b:#ff4fb6; --c:#ff9f1c;
      --shadow: 0 18px 60px rgba(0,0,0,.16);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(circle at 15% 10%, rgba(255,255,255,.9) 0 7%, transparent 9%),
        radial-gradient(circle at 85% 18%, rgba(255,255,255,.85) 0 6%, transparent 8%),
        radial-gradient(circle at 22% 84%, rgba(255,255,255,.8) 0 7%, transparent 9%),
        linear-gradient(155deg, var(--bg1), var(--bg2), var(--bg3));
      min-height:100vh;
    }
    header{ max-width: 1180px; margin: 0 auto; padding: 18px 14px 6px; }
    h1{ margin:0 0 6px; font-size: 22px; letter-spacing:.2px; }
    .subtitle{ margin:0; color: var(--muted); line-height: 1.35; font-size: 14px; font-weight: 850; }

    main{ max-width: 1180px; margin: 0 auto; padding: 12px 14px 24px; }
    .app{
      background: var(--card);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      border: 2px solid rgba(19,35,63,.10);
      overflow:hidden;
    }

    .topbar{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      padding: 14px;
      background: linear-gradient(90deg, rgba(122,92,255,.16), rgba(255,79,182,.12), rgba(255,159,28,.14));
      border-bottom: 2px dashed rgba(19,35,63,.18);
    }
    .control{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ font-size:13px; color: var(--muted); font-weight: 1000; letter-spacing: .15px; }
    select, button{
      border-radius: 14px;
      border: 2px solid rgba(19,35,63,.16);
      background: #fff;
      color: var(--ink);
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 1000;
      outline: none;
    }
    button{
      cursor:pointer;
      box-shadow: 0 6px 0 rgba(19,35,63,.10);
      transition: transform .06s ease;
    }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(122,92,255,.35); background: rgba(122,92,255,.12); }
    button.ghost{ background: rgba(255,255,255,.75); }
    button.small{ padding: 7px 10px; font-size: 13px; border-radius: 12px; }

    .matrix{ display:grid; grid-template-columns: 1fr; gap: 12px; padding: 14px; }
    @media (min-width: 940px){ .matrix{ grid-template-columns: 1fr 1fr 1fr; } }

    .pane{
      border-radius: 16px;
      border: 2px solid rgba(19,35,63,.12);
      background: rgba(255,255,255,.80);
      padding: 12px;
      min-height: 320px;
    }
    .paneTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom: 10px;
    }
    .paneTitle h2{ margin:0; font-size: 14px; letter-spacing:.2px; color: var(--muted); font-weight: 1100; }
    .pill{
      display:inline-block; padding: 4px 10px; border-radius: 999px;
      font-size: 12px; font-weight: 1100;
      border: 2px solid rgba(19,35,63,.12);
      background: rgba(255,159,28,.18);
    }

    .rootCard{
      text-align:center;
      padding: 14px 12px;
      border-radius: 16px;
      border: 2px solid rgba(122,92,255,.22);
      background:
        radial-gradient(circle at 20% 10%, rgba(255,79,182,.16), transparent 35%),
        radial-gradient(circle at 85% 30%, rgba(122,92,255,.18), transparent 35%),
        radial-gradient(circle at 30% 90%, rgba(255,159,28,.20), transparent 35%),
        rgba(122,92,255,.06);
      min-height: 320px;
      display:flex; flex-direction:column; justify-content:flex-start; gap:10px;
    }
    .rootText{ font-size: 44px; font-weight: 1200; letter-spacing: .6px; line-height: 1; margin-top: 6px;}
    .rootAlt{ font-size: 13px; color: var(--muted); font-weight: 950; }
    .rootMeaning{ font-size: 16px; font-weight: 1200; }
    .tiny{ font-size: 12px; color: var(--muted); font-weight: 900; line-height: 1.35; }

    .chips{
      display:flex; flex-wrap:wrap; justify-content:center;
      gap:8px; margin-top: 2px;
    }
    .chip{
      border-radius: 999px;
      border: 2px solid rgba(19,35,63,.14);
      background: rgba(255,255,255,.78);
      padding: 7px 10px;
      font-weight: 1150;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(255,79,182,.75);
      box-shadow: 0 0 0 4px rgba(255,79,182,.16);
      background: rgba(255,79,182,.10);
    }

    .list{
      height: 250px; overflow:auto; padding-right: 4px;
      border-radius: 14px; border: 2px dashed rgba(19,35,63,.18);
      background: rgba(255,255,255,.78);
    }
    .item{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      padding: 10px 10px; margin: 8px;
      border-radius: 14px; border: 2px solid rgba(19,35,63,.12);
      background: #fff; cursor:pointer; user-select:none;
    }
    .item strong{ font-size: 16px; font-weight: 1200; }
    .item span{ color: var(--muted); font-size: 12px; font-weight: 950; }
    .item.active{
      border-color: rgba(255,79,182,.70);
      box-shadow: 0 0 0 4px rgba(255,79,182,.16);
      background: rgba(255,79,182,.08);
    }

    .outputs{
      padding: 0 14px 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 940px){ .outputs{ grid-template-columns: 1fr 1fr; } }
    .outCard{
      border-radius: 16px;
      border: 2px solid rgba(19,35,63,.12);
      background: rgba(255,255,255,.88);
      padding: 12px;
    }
    .outLabel{ font-size: 12px; color: var(--muted); font-weight: 1100; letter-spacing:.2px; margin-bottom: 6px; }
    .outValue{ font-size: 22px; font-weight: 1250; letter-spacing:.2px; min-height: 28px; }
    .meaning{ font-size: 14px; color: var(--ink); font-weight: 950; line-height: 1.4; }

    .bubble{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:1100;
      padding: 6px 10px; border-radius: 999px;
      font-size: 12px; margin-top: 10px;
      border: 2px solid rgba(19,35,63,.12);
      background: rgba(255,255,255,.65);
      color: var(--muted);
      flex-wrap:wrap;
    }
    .good{
      border-color: rgba(46,204,113,.35);
      background: rgba(46,204,113,.16);
      color: #0e3b1f;
    }
    .warn{
      border-color: rgba(255,159,28,.45);
      background: rgba(255,159,28,.18);
      color: #5a3a00;
    }
    .bad{
      border-color: rgba(255,79,182,.55);
      background: rgba(255,79,182,.14);
      color: #5a0b2f;
    }

    .question{ font-size: 14px; font-weight: 1200; color: var(--ink); margin: 6px 0 10px; }

    details{
      margin-top: 10px;
      border-radius: 14px;
      border: 2px solid rgba(19,35,63,.10);
      background: rgba(255,255,255,.7);
      padding: 10px 10px;
    }
    summary{ cursor:pointer; font-weight: 1100; color: var(--muted); }
    .bank{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .bankSmall{ font-size: 12px; color: var(--muted); font-weight: 950; line-height: 1.35;}
    .bankList{
      margin-top: 10px;
      max-height: 180px;
      overflow:auto;
      border-radius: 14px;
      border: 2px dashed rgba(19,35,63,.18);
      background: rgba(255,255,255,.78);
      padding: 10px;
      font-size: 13px;
      font-weight: 900;
      color: var(--ink);
      line-height: 1.45;
    }
    .wordTag{
      display:inline-block;
      padding: 4px 8px;
      margin: 4px 6px 0 0;
      border-radius: 999px;
      border: 2px solid rgba(19,35,63,.10);
      background: rgba(122,92,255,.08);
    }
    .wordTag.hit{
      background: rgba(46,204,113,.14);
      border-color: rgba(46,204,113,.30);
    }
    .wordTag.miss{
      background: rgba(255,79,182,.10);
      border-color: rgba(255,79,182,.30);
    }

    .sentenceArea{
      width: 100%;
      border-radius: 14px;
      border: 2px solid rgba(19,35,63,.14);
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 900;
      resize: vertical;
      min-height: 90px;
      outline:none;
    }
  </style>
</head>

<body>
<header>
  <h1>Morpheme Matrix Playground</h1>
  <p class="subtitle">
    Pick a matrix, then build: <b>left + base + right</b>.
    Then decide: <b>Real word or fake word?</b> (and prove it!)
  </p>
</header>

<main>
  <div class="app" role="application" aria-label="Morpheme Matrix Playground">
    <div class="topbar">
      <div class="control">
        <label for="matrixSelect">Matrix:</label>
        <select id="matrixSelect" aria-label="Choose a matrix"></select>
      </div>
      <div class="control">
        <button id="clearBtn" class="ghost">Clear</button>
        <button id="randomBtn" class="primary">Random Combo</button>
        <button id="prefetchBtn" class="ghost">Prefetch definitions (this matrix)</button>
      </div>
    </div>

    <div class="matrix">
      <section class="pane" aria-label="Left side parts">
        <div class="paneTitle">
          <h2 id="leftTitle">Left Parts</h2>
          <span class="pill" id="leftCount">0 options</span>
        </div>
        <div class="list" id="leftList" tabindex="0" aria-label="Left list"></div>
        <div class="tiny">Tip: click again to turn a selection off.</div>
      </section>

      <section class="rootCard" aria-label="Base or middle form">
        <div class="rootAlt" id="rootAlt">‚Äî</div>

        <div class="rootText" id="rootText">‚Äî</div>
        <div class="chips" id="baseChips" aria-label="Base spelling choices"></div>

        <div class="rootMeaning" id="rootMeaning">‚Äî</div>
        <div class="tiny" id="rootMeta"></div>
        <div id="statusBubble"></div>
      </section>

      <section class="pane" aria-label="Right side parts">
        <div class="paneTitle">
          <h2 id="rightTitle">Right Parts</h2>
          <span class="pill" id="rightCount">0 options</span>
        </div>
        <div class="list" id="rightList" tabindex="0" aria-label="Right list"></div>
        <div class="tiny">Yes ‚Äî you can choose BOTH a left part and a right part.</div>
      </section>
    </div>

    <div class="outputs">
      <div class="outCard" aria-label="Word sum">
        <div class="outLabel">WORD SUM</div>
        <div class="outValue" id="wordSum">‚Äî</div>
        <div class="tiny" id="partMeanings">‚Äî</div>

        <details>
          <summary>Word Bank (Word Key for this matrix)</summary>
          <div class="bank">
            <div class="bankSmall" id="bankStats">‚Äî</div>
            <div class="control">
              <button id="copyWordsBtn" class="small ghost">Copy Word Bank</button>
              <button id="exportDefsBtn" class="small ghost">Export saved definitions</button>
              <button id="importDefsBtn" class="small ghost">Import definitions</button>
            </div>
          </div>
          <div class="bankList" id="bankList">‚Äî</div>
          <div class="tiny">Green = in Word Key. Pink = not in Word Key (yet). Kids can still test it!</div>
        </details>
      </div>

      <div class="outCard" aria-label="Word and definition">
        <div class="outLabel">WORD + DEFINITION</div>
        <div class="question">Is this a real word or a fake word? How do you know?</div>

        <div class="outValue" id="finalWord">‚Äî</div>
        <div class="meaning" id="finalDefinition">Build a combo to see a definition.</div>
        <div id="comboBubble"></div>

        <details open>
          <summary>Sentence Test</summary>
          <div class="tiny">Try using the word in a sentence. Does it make sense? Would you see it in a book?</div>
          <textarea id="sentenceBox" class="sentenceArea" placeholder="Write a sentence using your word..."></textarea>
          <div class="tiny" id="sentencePrompts"></div>
        </details>
      </div>
    </div>
  </div>
</main>

<script>
/* =========================================================
   DATA (Matrices + Word Key)
   - Matrices come from the PDF matrix pages (1‚Äì25).
   - Word Key comes from PDF pages 34‚Äì37.
   ========================================================= */

const MATRICES = [{"num": 1, "family": "Latin", "label": "Latin 1: form", "baseVariants": ["form"], "baseMeaning": "to shape", "left": ["in", "re", "de"], "right": ["s", "ed", "ing", "er", "ation", "al"]}, {"num": 2, "family": "Latin", "label": "Latin 2: port", "baseVariants": ["port"], "baseMeaning": "to carry", "left": ["im", "re", "de"], "right": ["s", "ed", "ing", "er", "ion, ation", "able", "al"]}, {"num": 3, "family": "Latin", "label": "Latin 3: rupt", "baseVariants": ["rupt"], "baseMeaning": "to break or burst", "left": ["dis", "inter", "e"], "right": ["s", "ed", "ing", "er", "tion", "ible", "ive"]}, {"num": 4, "family": "Latin", "label": "Latin 4: tract", "baseVariants": ["tract"], "baseMeaning": "to draw or pull", "left": ["dis", "re", "de", "sub"], "right": ["s", "ed", "ing", "or", "ion", "able, ible"]}, {"num": 5, "family": "Latin", "label": "Latin 5: scrib, script", "baseVariants": ["scrib", "script"], "baseMeaning": "to write", "left": ["in", "de", "pre", "sub"], "right": ["s", "ed", "ing", "er", "ion", "able"]}, {"num": 6, "family": "Latin", "label": "Latin 6: spect", "baseVariants": ["spect"], "baseMeaning": "to see, watch, or observe", "left": ["in", "re", "sus"], "right": ["s", "ed", "ing", "er", "or", "ion", "able", "ive"]}, {"num": 7, "family": "Latin", "label": "Latin 7: struct", "baseVariants": ["struct"], "baseMeaning": "to build", "left": ["in", "de", "con"], "right": ["s", "ed", "ing", "or", "ion", "ive"]}, {"num": 8, "family": "Latin", "label": "Latin 8: flect, flex", "baseVariants": ["flect", "flex"], "baseMeaning": "to bend or curve", "left": ["in", "re", "de"], "right": ["s/es", "ed", "ing", "or", "ion", "ive"]}, {"num": 9, "family": "Latin", "label": "Latin 9: dict", "baseVariants": ["dict"], "baseMeaning": "to say or tell", "left": ["in", "pre", "inter"], "right": ["s", "ed", "ing", "able", "ive", "ion"]}, {"num": 10, "family": "Latin", "label": "Latin 10: fer", "baseVariants": ["fer"], "baseMeaning": "to bear or yield", "left": ["in", "re", "de", "pre", "trans"], "right": ["s", "ed", "ing", "able", "al"]}, {"num": 11, "family": "Latin", "label": "Latin 11: mit, miss", "baseVariants": ["mit", "miss"], "baseMeaning": "to send", "left": ["dis", "re", "sub", "trans"], "right": ["s/es", "ed", "ing", "er", "ion", "ible", "al"]}, {"num": 12, "family": "Latin", "label": "Latin 12: duce, duct", "baseVariants": ["duce", "duct"], "baseMeaning": "to lead", "left": ["in", "de", "re", "con", "pro"], "right": ["s", "ed", "ing", "or", "ion", "ible", "ive"]}, {"num": 13, "family": "Latin", "label": "Latin 13: vers, vert", "baseVariants": ["vers", "vert"], "baseMeaning": "to turn", "left": ["in", "re", "sub", "con"], "right": ["s", "ed", "ing", "ion", "ive"]}, {"num": 14, "family": "Latin", "label": "Latin 14: fact, fect, fict", "baseVariants": ["fact", "fect", "fict"], "baseMeaning": "to make or do", "left": ["in", "de", "per"], "right": ["s", "ed", "ing", "or", "ion", "al", "ive"]}, {"num": 15, "family": "Latin", "label": "Latin 15: tend, tens, tent", "baseVariants": ["tend", "tens", "tent"], "baseMeaning": "to stretch or strain", "left": ["in", "dis", "pre", "con"], "right": ["s", "ed", "ing", "er", "ion", "ive"]}, {"num": 16, "family": "Latin", "label": "Latin 16: ceipt, ceive, cept", "baseVariants": ["ceipt", "ceive", "cept"], "baseMeaning": "to take or catch", "left": ["de", "re", "inter", "con", "per", "ex"], "right": ["s", "ed", "ing", "er", "or", "ion", "able", "ive"]}, {"num": 17, "family": "Latin", "label": "Latin 17: tain, ten, tin", "baseVariants": ["tain", "ten", "tin"], "baseMeaning": "to hold", "left": ["re", "de", "con", "per", "sus"], "right": ["s", "ed", "ing", "er", "able", "tion"]}, {"num": 18, "family": "Latin", "label": "Latin 18: pos, pound", "baseVariants": ["pos", "pound"], "baseMeaning": "to put in place or set", "left": ["im", "dis", "de", "com", "ex", "pro"], "right": ["s", "ed", "ing", "er", "or", "tion", "al"]}, {"num": 19, "family": "Greek", "label": "Greek 19: gram, graph", "baseVariants": ["gram", "graph"], "baseMeaning": "written or drawn", "left": ["auto", "chrono", "demo", "geo", "hydro", "phono", "photo", "tele", "thermo", "autobio", "bio"], "right": ["er", "ic", "ical", "y"]}, {"num": 20, "family": "Greek", "label": "Greek 20: logy, ology", "baseVariants": ["logy", "ology"], "baseMeaning": "study of", "left": ["bio", "chrono", "geo", "hydro", "graph", "meter", "phono", "psych", "techn", "microbio"], "right": ["ic", "ical", "ist"]}, {"num": 21, "family": "Greek", "label": "Greek 21: meter, metr", "baseVariants": ["meter", "metr"], "baseMeaning": "measure", "left": ["bio", "chrono", "geo", "grapho", "hydro", "micro", "photo", "sphero", "tele", "thermo"], "right": ["ic", "y"]}, {"num": 22, "family": "Greek", "label": "Greek 22: phone, phon", "baseVariants": ["phone", "phon"], "baseMeaning": "sound", "left": ["geo", "gramo", "hydro", "micro", "tele"], "right": ["eme", "ic"]}, {"num": 23, "family": "Greek", "label": "Greek 23: sphere", "baseVariants": ["sphere"], "baseMeaning": "circle", "left": ["astro", "bio", "eco", "geo", "hemi", "hydro", "micro", "photo", "thermo"], "right": ["ic"]}, {"num": 24, "family": "Greek", "label": "Greek 24: cracy, crat", "baseVariants": ["cracy", "crat"], "baseMeaning": "rule", "left": ["auto", "demo", "techno"], "right": ["ic"]}, {"num": 25, "family": "Greek", "label": "Greek 25: scope", "baseVariants": ["scope"], "baseMeaning": "watch or see", "left": ["bio", "chrono", "hydro", "micro", "phono", "photo", "tele", "thermo"], "right": ["ic"]}];

const WORD_KEY = {"1":["forms","formed","forming","former","formation","formal","inform","reform","deform","informs","informed","informing","informer","information","informal","reforms","reformed","reforming","reformer","reformation","deforms","deformed","deforming","deformer","deformation"],"2":["ports","ported","porting","porter","portion","portable","portal","import","report","deport","imports","imported","importing","importer","importation","importable","reports","reported","reporting","reporter","reportable","deports","deported","deporting","deportation","deportable"],"3":["disrupt","interrupt","erupt","disrupts","disrupted","disrupting","disrupter","disruption","disruptive","interrupts","interrupted","interrupting","interrupter","interruption","interruptible","interruptive","erupts","erupted","erupting","eruption","eruptible","eruptive"],"4":["tracts","tractor","traction","tractable","distract","retract","detract","subtract","distracts","distracted","distracting","distractor","distraction","distractable","retracts","retracted","retracting","retractor","retraction","retractable","detracts","detracted","detracting","detractor","detraction","detractable","subtracts","subtracted","subtracting","subtractor","subtraction","subtractable"],"5":["scribes","scribed","scribing","scriber","scribes","describes","described","describing","describer","description","descript","prescribes","prescribed","prescribing","prescriber","prescription","subscribes","subscribed","subscribing","subscriber","subscription","script","scripts","scripted","scripting","scripture","inscribe","inscribes","inscribed","inscribing","inscription","scribe","scribal","describable","prescribable","subscribable"],"6":["spects","spected","specting","specter","spectacle","inspect","respect","suspect","inspects","inspected","inspecting","inspector","inspection","inspective","respects","respected","respecting","respecter","respectable","respective","suspects","suspected","suspecting","suspecter","suspicion","suspectable","suspective"],"7":["structs","structed","structing","structor","structure","instruction","construct","destruct","instruct","instructs","instructed","instructing","instructor","instruction","instructive","constructs","constructed","constructing","constructor","construction","constructive","destructs","destructed","destructing","destructor","destruction","destructive"],"8":["flexes","flexed","flexing","flexor","flexion","inflect","reflect","deflect","inflects","inflected","inflecting","inflector","inflection","inflective","reflects","reflected","reflecting","reflector","reflection","reflective","deflects","deflected","deflector","deflection","deflective","reflex","reflexes","reflexed","reflexing","reflexive"],"9":["indict","predict","interdict","indicts","indicted","indicting","indictable","predicts","predicted","predicting","prediction","predictable","predictive","interdicts","interdicted","interdicting","interdiction","interdictive"],"10":["fers","fered","fering","ferer","infer","refer","defer","prefer","transfer","infers","inferred","inferring","inference","inferrable","refers","referred","referring","referrer","reference","referrable","defers","deferred","deferring","deferrable","prefers","preferred","preferring","preference","preferable","transfers","transferred","transferring","transferable"],"11":["mits","mitted","mitting","mitter","mission","missile","dismiss","remit","submit","transmit","dismisses","dismissed","dismissing","dismissal","remits","remitted","remitting","remitter","remission","submits","submitted","submitting","submitter","submission","transmits","transmitted","transmitting","transmitter","transmission","transmissible","transmittal"],"12":["duces","duced","ducing","ducer","duction","ducible","ducts","ducted","ducting","ductor","ductive","induce","reduce","deduce","conduce","produce","induces","induced","inducing","inducer","induction","inducible","reduces","reduced","reducing","reducer","reduction","reducible","deduces","deduced","deducing","deducer","deduction","deducible","conduces","conduced","conducing","conducer","conduction","conduct","conducts","conducted","conducting","conductor","conductive","produces","produced","producing","producer","production","producible"],"13":["verses","versed","versing","version","versatile","invert","revert","subvert","convert","inverts","inverted","inverting","inverter","inversion","invertible","reverts","reverted","reverting","reverter","reversion","revertible","subverts","subverted","subverting","subverter","subversion","subversive","converts","converted","converting","converter","conversion","convertible","converses","conversed","conversing","converse","conversant","conversational"],"14":["facts","facted","facting","factor","faction","factual","infect","defect","perfect","infects","infected","infecting","infecter","infection","infectious","infective","defects","defected","defecting","defector","defection","defective","perfects","perfected","perfecting","perfecter","perfection","perfectible","perfective","effects","effected","effecting","effector","effect","effective","fiction","fictitious"],"15":["intend","distend","pretend","contend","intends","intended","intending","intender","distends","distended","distending","pretends","pretended","pretending","pretender","contends","contended","contending","contender","intent","content","intents","intention","intentions","contents","contention","contentions","pretentions","intense","pretense","intensive","pretenses","tenses","tensed","tensing","tenser","tension"],"16":["deceit","receipt","conceit","receipts","deceive","receive","conceive","perceive","deceives","deceived","deceiving","deceiver","deception","deceivable","receives","received","receiving","receiver","reception","receivable","conceives","conceived","conceiving","conceiver","conception","conceivable","perceives","perceived","perceiving","perceiver","perception","perceivable"],"17":["tains","tained","taining","tainer","tainable","retains","retained","retaining","retainer","retention","retainable","detains","detained","detaining","detainer","detention","detainable","contains","contained","containing","container","containable","pertains","pertained","pertaining","pertainer","pertainable","sustains","sustained","sustaining","sustainer","sustainable","ten","tens","tended","tending","tender","tension","tent","tents","tented","tenting","tenter"],"18":["poses","posed","posing","poser","position","positional","impose","dispose","depose","compose","expose","propose","imposes","imposed","imposing","imposer","imposition","imposable","disposes","disposed","disposing","disposer","disposition","disposable","deposes","deposed","deposing","deposer","deposition","deposable","composes","composed","composing","composer","composition","composable","exposes","exposed","exposing","exposer","exposition","exposable","proposes","proposed","proposing","proposer","proposition","proposable"],"19":["autograph","biograph","chronogram","chronograph","hydrograph","phonogram","phonograph","photogram","photograph","telegram","telegraph","thermogram","thermograph","autobiographer","biographer","chronographer","hydrographer","phonographer","photographer","telegrapher","telegrapher","thermographer","autographic","biographic","chronographic","hydrographic","phonographic","photographic","telegraphic","thermographic","autobiographic","biographical","chronographical","hydrographical","phonographical","photographical","telegraphical","thermographical","autobiography","biography","chronography","hydrography","phonography","photography","telegraphy","thermography"],"20":["biology","chronology","geology","hydrology","graphology","meteorology","phonology","psychology","technology","microbiology","biologic","chronologic","geologic","hydrologic","meteorologic","phonologic","psychologic","technologic","microbiologic","biological","chronological","geological","hydrological","meteorological","phonological","psychological","technological","microbiological","biologist","chronologist","geologist","hydrologist","phonologist","psychologist","technologist","microbiologist"],"21":["chronometer","geometer","hydrometer","micrometer","photometer","thermometer","chronometric","geometric","hydrometric","micrometric","photometric","thermometric","chronometry","geometry","hydrometry","micrometry","photometry","thermometry"],"22":["geophone","gramophone","hydrophone","microphone","telephone","phoneme","phonemic"],"23":["astrosphere","biosphere","ecosphere","geosphere","hemisphere","hydrosphere","microsphere","photosphere","thermosphere","biospheric","ecospheric","geospheric","hemispheric","hydrospheric","microspheric","photospheric","thermospheric"],"24":["autocracy","democracy","technocracy","autocrat","democrat","technocrat","autocratic","democratic","technocratic"],"25":["bioscope","chronoscope","hydroscope","microscope","phonoscope","photoscope","telescope","thermoscope","microscopic","telescopic"]};

const NONE = { text:"‚Äî", value:"", meaning:"(none)" };

// Prefix/suffix meanings (kid-friendly). If something isn't here, we still work.
const MEAN = {
  in: "in, into, or toward",
  im: "in, into, or toward",
  un: "not or opposite of",
  mis: "bad or wrong",
  dis: "not or apart",
  re: "again or back",
  de: "down or away from",
  pre: "before or earlier",
  en: "put into or onto",
  em: "put into or onto",
  sub: "below or under",
  inter: "between",
  con: "together",
  com: "together",
  pro: "forward",
  per: "through",
  trans: "across",
  sus: "under",
  ex: "out",
  e: "out",

  "s":"plural noun / singular verb",
  "s/es":"plural noun / singular verb",
  "es":"plural noun / singular verb",
  "ed":"past tense",
  "ing":"happening now",
  "er":"someone who",
  "or":"someone who",
  "ion":"act/state of",
  "tion":"act/state of",
  "sion":"act/state of",
  "ation":"act/state of",
  "ion, ation":"act/state of",
  "able":"can be",
  "ible":"can be",
  "able, ible":"can be",
  "al":"relating to",
  "ive":"causing/making",
  "ic":"relating to",
  "ical":"relating to",
  "ist":"one who",
  "y":"subject or science",
  "eme":"unit"
};

function part(text, meaning=""){
  const v = (text||"").trim();
  return { text: v || "‚Äî", value: v, meaning: meaning || "" };
}
function withMeanings(list){
  return [NONE, ...list.map(x => part(x, MEAN[x] || ""))];
}

/* =========================================================
   Definition cache (localStorage)
   ========================================================= */
const DEF_CACHE_KEY = "morphology_defs_v1";
const DEF_CACHE = loadDefs();

function loadDefs(){
  try{
    const raw = localStorage.getItem(DEF_CACHE_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === "object") ? obj : {};
  }catch{ return {}; }
}
function saveDefs(){
  try{ localStorage.setItem(DEF_CACHE_KEY, JSON.stringify(DEF_CACHE)); }catch{}
}
function norm(s){ return String(s||"").toLowerCase().trim(); }

async function fetchDefinition(word){
  const w = norm(word);
  if(!w || w === "‚Äî") return null;

  if(DEF_CACHE[w]){
    return { def: DEF_CACHE[w], source: "cache" };
  }

  try{
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(w)}`);
    if(!res.ok) return null;
    const data = await res.json();
    const first = Array.isArray(data) ? data[0] : null;
    const def = first?.meanings?.[0]?.definitions?.[0]?.definition;
    if(typeof def === "string" && def.trim()){
      DEF_CACHE[w] = def.trim();
      saveDefs();
      return { def: def.trim(), source: "dictionary" };
    }
    return null;
  }catch{
    return null;
  }
}

/* =========================================================
   Spelling helpers (tries likely spellings)
   - We DO NOT ‚Äúcorrect‚Äù kids; we offer options.
   - We try a few variants and then check Word Key + dictionary.
   ========================================================= */
const VOWELS = new Set(["a","e","i","o","u"]);

function generateSpellings(left, base, right){
  const forms = new Set();

  const raw = `${left}${base}${right}`;
  if(raw) forms.add(raw);

  // drop final 'e' before vowel suffix: duce+ion -> ducion (not perfect, but helps)
  if(base.endsWith("e") && right && VOWELS.has(right[0])){
    forms.add(`${left}${base.slice(0,-1)}${right}`);
  }

  // y -> i before common suffixes
  if(base.endsWith("y") && right && ["s","es","ed","ing","er","est","able","ible"].includes(right)){
    forms.add(`${left}${base.slice(0,-1)}i${right}`);
  }

  // handle comma suffix groups (e.g., "ion, ation" or "able, ible")
  // We'll keep those as-is in UI, but for building we try each option too.
  if(right && right.includes(",")){
    right.split(",").map(s=>s.trim()).filter(Boolean).forEach(r=>{
      forms.add(`${left}${base}${r}`);
      if(base.endsWith("e") && r && VOWELS.has(r[0])) forms.add(`${left}${base.slice(0,-1)}${r}`);
    });
  }

  return Array.from(forms).filter(Boolean);
}

/* =========================================================
   UI elements
   ========================================================= */
const matrixSelect = document.getElementById("matrixSelect");
const leftListEl = document.getElementById("leftList");
const rightListEl = document.getElementById("rightList");
const leftCountEl  = document.getElementById("leftCount");
const rightCountEl = document.getElementById("rightCount");

const leftTitleEl = document.getElementById("leftTitle");
const rightTitleEl = document.getElementById("rightTitle");

const rootTextEl   = document.getElementById("rootText");
const rootAltEl    = document.getElementById("rootAlt");
const baseChipsEl  = document.getElementById("baseChips");
const rootMeaningEl= document.getElementById("rootMeaning");
const rootMetaEl   = document.getElementById("rootMeta");
const statusBubble = document.getElementById("statusBubble");

const wordSumEl    = document.getElementById("wordSum");
const partMeaningsEl = document.getElementById("partMeanings");
const finalWordEl  = document.getElementById("finalWord");
const finalDefEl   = document.getElementById("finalDefinition");
const comboBubbleEl= document.getElementById("comboBubble");

const bankStatsEl = document.getElementById("bankStats");
const bankListEl = document.getElementById("bankList");

const clearBtn = document.getElementById("clearBtn");
const randomBtn = document.getElementById("randomBtn");
const prefetchBtn = document.getElementById("prefetchBtn");
const copyWordsBtn = document.getElementById("copyWordsBtn");
const exportDefsBtn = document.getElementById("exportDefsBtn");
const importDefsBtn = document.getElementById("importDefsBtn");

const sentenceBox = document.getElementById("sentenceBox");
const sentencePrompts = document.getElementById("sentencePrompts");

let current = MATRICES[0];
let chosenLeft = "";
let chosenRight = "";
let chosenBase = current.baseVariants[0];
let defReqToken = 0;

function renderMatrixSelect(){
  matrixSelect.innerHTML = "";
  MATRICES.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = String(m.num);
    opt.textContent = m.label;
    matrixSelect.appendChild(opt);
  });
}

function setStatus(html){
  statusBubble.innerHTML = html ? html : "";
}

function renderBaseChips(){
  baseChipsEl.innerHTML = "";
  const vars = current.baseVariants || [current.baseVariants?.[0] || ""];
  if(vars.length <= 1){
    baseChipsEl.style.display = "none";
    return;
  }
  baseChipsEl.style.display = "flex";

  vars.forEach(v=>{
    const chip = document.createElement("div");
    chip.className = "chip" + (v === chosenBase ? " active" : "");
    chip.textContent = v;
    chip.title = "Same meaning, different spelling. Try both!";
    chip.addEventListener("click", ()=>{
      chosenBase = v;
      renderAll();
    });
    baseChipsEl.appendChild(chip);
  });
}

function renderRoot(){
  leftTitleEl.textContent = (current.family === "Latin") ? "Prefixes" : "Left Forms";
  rightTitleEl.textContent = "Suffixes / Right Parts";

  rootAltEl.textContent = `${current.family} ‚Ä¢ Matrix ${current.num}`;
  rootTextEl.textContent = chosenBase;
  rootMeaningEl.textContent = current.baseMeaning;

  rootMetaEl.textContent = `Build: left + base + right (choose both if you want).`;

  if((current.baseVariants||[]).length > 1){
    setStatus(`<div class="bubble good">Same meaning ‚Äî different spellings. Try both!</div>`);
  } else {
    setStatus(`<div class="bubble good">Ready to build!</div>`);
  }

  renderBaseChips();
}

function mkItem(obj, isActive){
  const div = document.createElement("div");
  div.className = "item" + (isActive ? " active" : "");
  div.innerHTML = `<strong>${obj.text}</strong><span>${obj.meaning || ""}</span>`;
  return div;
}

function renderLists(){
  leftListEl.innerHTML = "";
  rightListEl.innerHTML = "";

  const leftParts = withMeanings(current.left || []);
  const rightParts = withMeanings(current.right || []);

  leftParts.forEach(p=>{
    const div = mkItem(p, p.value === chosenLeft);
    div.addEventListener("click", ()=>{
      chosenLeft = (chosenLeft === p.value) ? "" : p.value;
      renderAll();
    });
    leftListEl.appendChild(div);
  });

  rightParts.forEach(s=>{
    const div = mkItem(s, s.value === chosenRight);
    div.addEventListener("click", ()=>{
      chosenRight = (chosenRight === s.value) ? "" : s.value;
      renderAll();
    });
    rightListEl.appendChild(div);
  });

  leftCountEl.textContent = `${leftParts.length} options`;
  rightCountEl.textContent = `${rightParts.length} options`;
}

function wordSum(){
  const parts = [];
  if(chosenLeft) parts.push(chosenLeft);
  parts.push(chosenBase);
  if(chosenRight) parts.push(chosenRight);
  return parts.join(" + ");
}

function partMeanings(){
  const leftM = chosenLeft ? (MEAN[chosenLeft] || "") : "";
  const rightM = chosenRight ? (MEAN[chosenRight] || "") : "";
  const parts = [];
  if(chosenLeft) parts.push(`(${chosenLeft}-) ${leftM || "left meaning"}`);
  parts.push(`${chosenBase} = ${current.baseMeaning}`);
  if(chosenRight) parts.push(`(-${chosenRight}) ${rightM || "right meaning"}`);
  return parts.join(" ‚Ä¢ ");
}

function generatedDefinition(leftMeaning, baseMeaning, rightMeaning){
  const bits = [];
  if(leftMeaning) bits.push(leftMeaning);
  if(baseMeaning) bits.push(baseMeaning);
  const core = bits.filter(Boolean).join(" + ") || baseMeaning || "something";
  if(rightMeaning) return `Possible meaning (if it were a word): something related to ‚Äú${core}‚Äù and ‚Äú${rightMeaning}.‚Äù`;
  return `Possible meaning (if it were a word): something related to ‚Äú${core}.‚Äù`;
}

function getWordKeySet(){
  const list = WORD_KEY[String(current.num)] || [];
  return new Set(list.map(norm));
}

function pickBestCandidate(candidates){
  const wk = getWordKeySet();
  for(const c of candidates){
    if(wk.has(norm(c))) return { word: c, inWordKey: true };
  }
  return { word: candidates[0] || "‚Äî", inWordKey: false };
}

function buildCandidate(){
  const left = chosenLeft || "";
  const right = chosenRight || "";
  const candidates = generateSpellings(left, chosenBase, right);
  if(!candidates.length) return { word:"‚Äî", candidates:[], inWordKey:false };
  const best = pickBestCandidate(candidates);
  return { word: best.word, candidates, inWordKey: best.inWordKey };
}

function renderWordBank(highlightWord){
  const list = WORD_KEY[String(current.num)] || [];
  const wkSet = new Set(list.map(norm));

  bankStatsEl.textContent = `Word Bank size: ${list.length} ‚Ä¢ (These are the ‚Äúreal-word‚Äù combos listed in the PDF Word Key.)`;

  const hw = norm(highlightWord);
  bankListEl.innerHTML = list.map(w=>{
    const isHit = (norm(w) === hw);
    const cls = "wordTag " + (isHit ? "hit" : "");
    return `<span class="${cls}">${w}</span>`;
  }).join("");
}

function setSentencePrompts(word){
  if(!word || word==="‚Äî"){
    sentencePrompts.textContent = "";
    return;
  }
  sentencePrompts.innerHTML = `
    <div class="tiny">
      Prompts: ‚ÄúI noticed that <b>${word}</b> means‚Ä¶‚Äù ‚Ä¢ ‚ÄúA time I might use <b>${word}</b> is‚Ä¶‚Äù ‚Ä¢
      ‚ÄúI think <b>${word}</b> is real/fake because‚Ä¶‚Äù
    </div>
  `;
}

async function renderDefinitionAndBadges(){
  const token = ++defReqToken;

  if(!chosenLeft && !chosenRight){
    finalWordEl.textContent = "‚Äî";
    finalDefEl.textContent = "Build a combo to see a definition.";
    comboBubbleEl.innerHTML = "";
    renderWordBank("");
    setSentencePrompts("");
    return;
  }

  const { word, candidates, inWordKey } = buildCandidate();

  finalWordEl.textContent = word;
  renderWordBank(word);
  setSentencePrompts(word);

  // ‚ÄúMeaning math‚Äù (still shown in word sum card)
  const leftMeaning = chosenLeft ? (MEAN[chosenLeft] || "") : "";
  const rightMeaning = chosenRight ? (MEAN[chosenRight] || "") : "";

  // If the best candidate isn‚Äôt in Word Key, still check dictionary.
  const defObj = await fetchDefinition(word);

  if(token !== defReqToken) return;

  const wkBadge = inWordKey
    ? `<div class="bubble good">‚úÖ In Word Key (PDF ‚Äúreal word‚Äù list)</div>`
    : `<div class="bubble warn">ü§î Not in Word Key ‚Äî still test it! (Try the other base spelling too.)</div>`;

  const multiBadge = (candidates.length > 1)
    ? `<div class="bubble">Spelling tries: ${candidates.slice(0,5).join(", ")}${candidates.length>5 ? "‚Ä¶" : ""}</div>`
    : "";

  if(defObj && defObj.def){
    finalDefEl.textContent = defObj.def;
    comboBubbleEl.innerHTML = `
      ${wkBadge}
      <div class="bubble good">üìö Real definition (${defObj.source === "cache" ? "saved" : "dictionary"})</div>
      ${multiBadge}
    `;
  } else {
    finalDefEl.textContent = generatedDefinition(leftMeaning, current.baseMeaning, rightMeaning);
    comboBubbleEl.innerHTML = `
      ${wkBadge}
      <div class="bubble bad">No dictionary definition found ‚Äî so we built a ‚Äúpossible meaning.‚Äù</div>
      ${multiBadge}
    `;
  }
}

function renderOutputs(){
  wordSumEl.textContent = wordSum();
  partMeaningsEl.textContent = partMeanings();
  renderDefinitionAndBadges();
}

function renderAll(){
  renderRoot();
  renderLists();
  renderOutputs();
}

function setCurrentMatrix(num){
  current = MATRICES.find(m => String(m.num) === String(num)) || MATRICES[0];
  chosenLeft = "";
  chosenRight = "";
  chosenBase = (current.baseVariants && current.baseVariants.length) ? current.baseVariants[0] : "";
  sentenceBox.value = "";
  renderAll();
}

/* =========================================================
   Buttons
   ========================================================= */
document.getElementById("clearBtn").addEventListener("click", ()=>{
  chosenLeft = "";
  chosenRight = "";
  sentenceBox.value = "";
  renderAll();
});

document.getElementById("randomBtn").addEventListener("click", ()=>{
  const leftOpts = (current.left || []);
  const rightOpts = (current.right || []);

  chosenLeft = (Math.random() < 0.75 && leftOpts.length) ? leftOpts[Math.floor(Math.random()*leftOpts.length)] : "";
  chosenRight = (Math.random() < 0.75 && rightOpts.length) ? rightOpts[Math.floor(Math.random()*rightOpts.length)] : "";

  const vars = current.baseVariants || [];
  if(vars.length) chosenBase = vars[Math.floor(Math.random()*vars.length)];

  renderAll();
});

matrixSelect.addEventListener("change", ()=> setCurrentMatrix(matrixSelect.value));

copyWordsBtn.addEventListener("click", async ()=>{
  const list = WORD_KEY[String(current.num)] || [];
  const txt = list.join(", ");
  try{
    await navigator.clipboard.writeText(txt);
    setStatus(`<div class="bubble good">Copied Word Bank to clipboard!</div>`);
    setTimeout(()=>renderRoot(), 900);
  }catch{
    setStatus(`<div class="bubble warn">Copy failed ‚Äî your browser blocked clipboard.</div>`);
    setTimeout(()=>renderRoot(), 1200);
  }
});

exportDefsBtn.addEventListener("click", ()=>{
  const payload = JSON.stringify(DEF_CACHE, null, 2);
  const blob = new Blob([payload], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "morpheme-definitions.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});

importDefsBtn.addEventListener("click", ()=>{
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = async () => {
    const file = input.files && input.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(obj && typeof obj === "object"){
        for(const [k,v] of Object.entries(obj)){
          if(typeof v === "string" && v.trim()){
            DEF_CACHE[norm(k)] = v.trim();
          }
        }
        saveDefs();
        setStatus(`<div class="bubble good">Imported definitions!</div>`);
        setTimeout(()=>renderRoot(), 900);
      }
    }catch{
      setStatus(`<div class="bubble bad">Import failed ‚Äî invalid JSON file.</div>`);
      setTimeout(()=>renderRoot(), 1200);
    }
  };
  input.click();
});

prefetchBtn.addEventListener("click", async ()=>{
  const words = WORD_KEY[String(current.num)] || [];
  if(!words.length){
    setStatus(`<div class="bubble warn">No Word Bank for this matrix.</div>`);
    setTimeout(()=>renderRoot(), 1000);
    return;
  }
  setStatus(`<div class="bubble warn">Prefetching‚Ä¶ (this may take a bit)</div>`);
  // Prefetch sequentially to be gentle
  let hit = 0;
  for(let i=0;i<words.length;i++){
    const w = words[i];
    const n = norm(w);
    if(DEF_CACHE[n]) { hit++; continue; }
    const defObj = await fetchDefinition(w);
    if(defObj && defObj.def) hit++;
    // light progress updates
    if(i % 10 === 0){
      setStatus(`<div class="bubble warn">Prefetching‚Ä¶ ${i+1}/${words.length} ‚Ä¢ saved: ${hit}</div>`);
    }
  }
  setStatus(`<div class="bubble good">Done! Saved definitions: ${hit}/${words.length}</div>`);
  setTimeout(()=>renderRoot(), 1200);
});

/* =========================================================
   Init
   ========================================================= */
renderMatrixSelect();
setCurrentMatrix(MATRICES[0].num);
matrixSelect.value = String(MATRICES[0].num);
</script>
</body>
</html>
